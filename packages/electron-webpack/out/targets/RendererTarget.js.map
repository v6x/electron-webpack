{"version":3,"sources":["../../src/targets/RendererTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { outputFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig } from \"read-config-file\"\nimport { DefinePlugin } from \"webpack\"\nimport { getDllAssets } from \"../configurators/dll\"\nimport { configureVueRenderer } from \"../configurators/vue/vue\"\nimport { WebpackConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { BaseTarget, configureFileLoader } from \"./BaseTarget\"\n\nconst MiniCssExtractPlugin = require(\"mini-css-extract-plugin\")\n\nexport class BaseRendererTarget extends BaseTarget {\n  constructor() {\n    super()\n  }\n\n  configureRules(configurator: WebpackConfigurator): void {\n    super.configureRules(configurator)\n\n    configurator.extensions.push(\".css\")\n\n    const miniLoaders = [MiniCssExtractPlugin.loader, \"css-loader\"]\n    const cssHotLoader = configurator.isProduction ? miniLoaders : [\"css-hot-loader\"].concat(miniLoaders)\n    if (!configurator.isProduction) {\n      // https://github.com/shepherdwind/css-hot-loader/issues/37\n      configurator.entryFiles.unshift(\"css-hot-loader/hotModuleReplacement\")\n    }\n\n    configurator.rules.push(\n      {\n        test: /\\.css$/,\n        use: cssHotLoader,\n      },\n      {\n        test: /\\.less$/,\n        use: cssHotLoader.concat(\"less-loader\"),\n      },\n      {\n        test: /\\.scss/,\n        use: cssHotLoader.concat(\"sass-loader\"),\n      },\n      {\n        test: /\\.(png|jpe?g|gif|svg)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"imgs\")\n        }\n      },\n      {\n        test: /\\.(mp4|webm|ogg|mp3|wav|flac|aac)(\\?.*)?$/,\n        loader: \"url-loader\",\n        options: configureFileLoader(\"media\"),\n      },\n      {\n        test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"fonts\")\n        }\n      },\n    )\n\n    if (configurator.hasDevDependency(\"ejs-html-loader\")) {\n      configurator.rules.push({\n        test: /\\.ejs$/,\n        loader: \"ejs-html-loader\",\n      })\n    }\n\n    if (configurator.hasDependency(\"vue\")) {\n      configureVueRenderer(configurator)\n    }\n    else {\n      configurator.rules.push({\n        test: /\\.(html)$/,\n        use: {\n          loader: \"html-loader\",\n        }\n      })\n    }\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    configurator.debug(\"Add ExtractTextPlugin plugin\")\n    configurator.plugins.push(new MiniCssExtractPlugin({filename: `${configurator.type === \"renderer-dll\" ? \"vendor\" : \"styles\"}.css`}))\n\n    // https://github.com/electron-userland/electrify/issues/1\n    if (!configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        \"process.env.NODE_ENV\": \"\\\"development\\\"\",\n      }))\n    }\n\n    await BaseTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nexport class RendererTarget extends BaseRendererTarget {\n  constructor() {\n    super()\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    // not configurable for now, as in the electron-vue\n    const customTemplateFile = path.join(configurator.projectDir, \"src/index.ejs\")\n    const HtmlWebpackPlugin = require(\"html-webpack-plugin\")\n    const nodeModulePath = configurator.isProduction ? null : path.resolve(configurator.projectDir, \"node_modules\")\n\n    configurator.plugins.push(new HtmlWebpackPlugin({\n      filename: \"index.html\",\n      template: (await statOrNull(customTemplateFile)) == null ? (await generateIndexFile(configurator, nodeModulePath)) : customTemplateFile,\n      minify: false,\n      nodeModules: nodeModulePath\n    }))\n\n    if (configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        __static: `process.resourcesPath + \"/static\"`\n      }))\n    }\n    else {\n      const contentBase = [path.join(configurator.projectDir, \"static\"), path.join(configurator.commonDistDirectory, \"renderer-dll\")];\n      (configurator.config as any).devServer = {\n        contentBase,\n        host: process.env.ELECTRON_WEBPACK_WDS_HOST || \"localhost\",\n        port: process.env.ELECTRON_WEBPACK_WDS_PORT || 9080,\n        hot: true,\n        overlay: true,\n      }\n    }\n\n    await BaseRendererTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nasync function computeTitle(configurator: WebpackConfigurator): Promise<string | null | undefined> {\n  const titleFromOptions = configurator.electronWebpackConfiguration.title\n  if (titleFromOptions == null || titleFromOptions === false) {\n    return null\n  }\n\n  if (titleFromOptions !== true) {\n    return titleFromOptions\n  }\n\n  let title: string | null | undefined = (configurator.metadata as any).productName\n  if (title == null) {\n    const electronBuilderConfig = await getConfig<any>({\n      packageKey: \"build\",\n      configFilename: \"electron-builder\",\n      projectDir: configurator.projectDir,\n      packageMetadata: new Lazy(() => Promise.resolve(configurator.metadata))\n    })\n    if (electronBuilderConfig != null) {\n      title = electronBuilderConfig.result.productName\n    }\n  }\n\n  if (title == null) {\n    title = configurator.metadata.name\n  }\n  return title\n}\n\nasync function generateIndexFile(configurator: WebpackConfigurator, nodeModulePath: string | null) {\n  // do not use add-asset-html-webpack-plugin - no need to copy vendor files to output (in dev mode will be served directly, in production copied)\n  const assets = await getDllAssets(path.join(configurator.commonDistDirectory, \"renderer-dll\"), configurator)\n  const scripts: Array<string> = []\n  const css: Array<string> = []\n  for (const asset of assets) {\n    if (asset.endsWith(\".js\")) {\n      scripts.push(`<script type=\"text/javascript\" src=\"${asset}\"></script>`)\n    }\n    else {\n      css.push(`<link rel=\"stylesheet\" href=\"${asset}\">`)\n    }\n  }\n\n  const title = await computeTitle(configurator)\n  const filePath = path.join(configurator.commonDistDirectory, \".renderer-index-template.html\")\n  await outputFile(filePath, `<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    ${title == null ? \"\" : `<title>${title}</title>`}\n    <script>\n      ${nodeModulePath == null ? \"\" : `require(\"module\").globalPaths.push(\"${nodeModulePath.replace(/\\\\/g, \"/\")}\")`}\n      ${!configurator.sourceDir ? \"\" : `require(\"source-map-support/source-map-support.js\").install()`}\n    </script>\n    ${scripts.join(\"\")}\n  ${css.join(\"\")}\n  </head>\n  <body>\n    <div id=\"app\"></div>\n  </body>\n</html>`)\n\n  return `!!html-loader?minimize=false&url=false!${filePath}`\n}\n"],"sourceRoot":""}
