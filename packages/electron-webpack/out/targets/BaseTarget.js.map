{"version":3,"sources":["../../src/targets/BaseTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin } from \"webpack\"\nimport { configureDll } from \"../configurators/dll\"\nimport { configureEslint } from \"../configurators/eslint\"\nimport { createBabelLoader } from \"../configurators/js\"\nimport { WebpackConfigurator } from \"../main\"\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\n\nexport class BaseTarget {\n  configureRules(configurator: WebpackConfigurator): void {\n    const rules = configurator.rules\n\n    const babelLoader = createBabelLoader(configurator)\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\n      rules.push({\n        test: /iview.src.*?js$/,\n        use: babelLoader\n      })\n    }\n\n    rules.push(\n      {\n        test: /\\.js$/,\n        exclude: /(node_modules|bower_components)/,\n        use: babelLoader\n      },\n      {\n        test: /\\.node$/,\n        use: \"node-loader\"\n      },\n    )\n\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\n      rules.push({\n        test: /\\.(njk|nunjucks)$/,\n        loader: \"nunjucks-loader\"\n      })\n    }\n\n    configureEslint(configurator)\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    const plugins = configurator.plugins\n\n    const dllManifest = await configureDll(configurator)\n    const mode = configurator.isProduction ? \"production\" : \"development\"\n\n    let optimization = configurator.config.optimization\n    if (optimization == null) {\n      optimization = {}\n      configurator.config.optimization = optimization\n    }\n\n    optimization.nodeEnv = mode\n    configurator.config.mode = mode\n\n    if (configurator.isProduction) {\n      if (configurator.env.minify !== false) {\n        const UglifyJsPlugin = require(\"uglifyjs-webpack-plugin\")\n        plugins.push(new UglifyJsPlugin({\n          parallel: true,\n          sourceMap: true,\n          uglifyOptions: {\n            compress: {\n              ecma: 7,\n            },\n          },\n        }))\n      }\n      optimization.minimize = true\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\n\n      // do not use ModuleConcatenationPlugin for HMR\n      // https://github.com/webpack/webpack-dev-server/issues/949\n      optimization.concatenateModules = true\n    }\n    else {\n      configureDevelopmentPlugins(configurator)\n    }\n\n    if (configurator.env.autoClean !== false) {\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\n    }\n\n    optimization.noEmitOnErrors = true\n\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\n    if (additionalEnvironmentVariables.length > 0) {\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\n    }\n  }\n}\n\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\n  return {\n    limit,\n    name: `${prefix}/[name]--[folder].[ext]`\n  }\n}\n\nfunction isAncestor(file: string, dir: string) {\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\n}\n\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\n  const plugins = configurator.plugins\n  configurator.config.optimization!!.namedModules = true\n  plugins.push(new DefinePlugin({\n    __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n  }))\n\n  plugins.push(new HotModuleReplacementPlugin())\n\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\n    plugins.push(new WebpackNotifierPlugin({\n      title: `Webpack - ${configurator.type}`,\n      suppressSuccess: \"initial\",\n      sound: false,\n    }))\n  }\n\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\n  }\n\n  // watch common code\n  let commonSourceDir = configurator.electronWebpackConfiguration.commonSourceDirectory\n  if (commonSourceDir == null) {\n    // not src/common, because it is convenient to just put some code into src to use it\n    commonSourceDir = path.join(configurator.projectDir, \"src\")\n  }\n\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\n\n  configurator.plugins.push(new WatchFilterPlugin(file => {\n    return file === commonSourceDir || (isAncestor(file, commonSourceDir!!) && (alienSourceDir != null && !file.startsWith(alienSourceDir)))\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\n}\n"],"sourceRoot":""}
