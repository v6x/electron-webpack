{"version":3,"sources":["../../src/plugins/WatchMatchPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import { Compiler } from \"webpack\"\n\nexport class WatchFilterPlugin {\n  constructor(private readonly filter: WatchFileSystemFilter, private readonly debug: any) {\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEnvironment.tap(\"WatchFilterPlugin\", () => {\n      (compiler as any).watchFileSystem = new IgnoringWatchFileSystem((compiler as any).watchFileSystem, this.filter, this.debug)\n    })\n  }\n}\n\ninterface WatchFileSystem {\n  watch(files: Array<string>, dirs: Array<string>, missing: Array<string>, startTime: number, options: any, callback: WatchFileSystemCallback, callbackUndelayed: () => void): void\n}\n\n// include or not\nexport type WatchFileSystemFilter = (file: string) => boolean\n\nexport type WatchFileSystemCallback = (error: Error | null, filesModified?: Array<string>, dirsModified?: Array<string>, missingModified?: Array<string>, fileTimestamps?: { [key: string]: number }, dirTimestamps?: { [key: string]: number }) => void\n\nclass IgnoringWatchFileSystem {\n  constructor(private readonly wfs: WatchFileSystem, private readonly filter: WatchFileSystemFilter, private readonly debug: any) {\n  }\n\n  watch(files: Array<string>, dirs: Array<string>, missing: Array<string>, startTime: number, options: any, callback: WatchFileSystemCallback, callbackUndelayed: () => void) {\n    const includedFiles: Array<string> = []\n    const includedDirs: Array<string> = []\n    const excludedFiles: Array<string> = []\n    const excludedDirs: Array<string> = []\n    separate(this.filter, files, includedFiles, excludedFiles)\n    separate(this.filter, dirs, includedDirs, excludedDirs)\n\n    if (this.debug.enabled) {\n      this.debug(`files:${stringifyList(files)}\\ndirs:${stringifyList(dirs)}\\nmissing:${stringifyList(missing)}`)\n      this.debug(`includedFiles:${stringifyList(includedFiles)}\\nincludedDirs:${stringifyList(includedDirs)}\\nexcludedFiles:${stringifyList(excludedFiles)}\\nexcludedDirs:${stringifyList(excludedDirs)}`)\n    }\n\n    return this.wfs.watch(includedFiles, includedDirs, missing, startTime, options, (error, filesModified, dirsModified, missingModified, fileTimestamps, dirTimestamps) => {\n      if (error != null) {\n        callback(error)\n        return\n      }\n\n      for (const p of excludedFiles) {\n        fileTimestamps![p] = 1\n      }\n\n      for (const p of excludedDirs) {\n        dirTimestamps![p] = 1\n      }\n\n      callback(null, filesModified, dirsModified, missingModified, fileTimestamps, dirTimestamps)\n    }, callbackUndelayed)\n  }\n}\n\nfunction separate(filter: WatchFileSystemFilter, list: Array<string>, included: Array<string>, excluded: Array<string>) {\n  for (const file of list) {\n    (filter(file) ? included : excluded).push(file)\n  }\n}\n\nfunction stringifyList(list: Array<string>) {\n  return `\\n  ${list.map(it => it.startsWith(process.cwd()) ? it.substring(process.cwd().length + 1) : it).join(\",\\n  \")}`\n}"],"sourceRoot":""}
